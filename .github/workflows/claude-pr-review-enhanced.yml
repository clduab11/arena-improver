name: Claude PR Review (Enhanced)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]  # Re-review after human feedback
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  schedule:
    - cron: '0 2 * * 1'  # Weekly dependency audit (Monday 2 AM)
  workflow_dispatch:  # Manual trigger

permissions:
  contents: write  # For auto-fix commits
  pull-requests: write
  issues: write

jobs:
  # Stage 0: Intelligent Routing
  route-review:
    name: Intelligent Review Routing
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && contains(github.event.comment.body, '@claude'))

    outputs:
      review_mode: ${{ steps.routing.outputs.review_mode }}
      priority: ${{ steps.routing.outputs.priority }}
      should_review: ${{ steps.routing.outputs.should_review }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyGithub

      - name: Run intelligent router
        id: routing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=${{ github.event.pull_request.number || github.event.issue.number }}
          python .github/scripts/intelligent_router.py \
            --pr-number "$PR_NUM" \
            --repo "${{ github.repository }}"

          # Load routing decision
          DECISION=$(cat routing_decision.json)
          echo "review_mode=$(echo $DECISION | jq -r '.review_mode')" >> $GITHUB_OUTPUT
          echo "priority=$(echo $DECISION | jq -r '.priority')" >> $GITHUB_OUTPUT
          echo "should_review=true" >> $GITHUB_OUTPUT

  # Stage 1: Fast Analysis (<30s)
  fast-analysis:
    name: Stage 1 - Fast Analysis
    runs-on: ubuntu-latest
    needs: route-review
    if: needs.route-review.outputs.should_review == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install analysis tools
        run: |
          pip install ruff bandit

      - name: Run fast checks
        run: |
          # Syntax check
          python -m py_compile **/*.py 2>&1 || true

          # Ruff linting
          ruff check . --output-format=json > ruff_results.json || true

          # Bandit security scan
          bandit -r . -f json -ll > bandit_results.json || true

      - name: Upload stage 1 results
        uses: actions/upload-artifact@v4
        with:
          name: stage1-results
          path: |
            ruff_results.json
            bandit_results.json

  # Stage 2: Security & Compliance Check
  security-check:
    name: Security & Compliance
    runs-on: ubuntu-latest
    needs: [route-review, fast-analysis]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run PII/credential scanner
        run: |
          # Scan all changed files for PII and credentials
          git diff --name-only origin/${{ github.base_ref }}...HEAD | while read file; do
            if [ -f "$file" ]; then
              python .github/scripts/security_compliance.py --scan "$file"
            fi
          done

      - name: Check file allowlist
        run: |
          echo "Verifying no sensitive files in PR..."
          # Implementation would check against blocklist

  # Stage 3: Cost-Optimized Claude Review
  claude-review:
    name: Stage 2 - Claude AI Review
    runs-on: ubuntu-latest
    needs: [route-review, fast-analysis, security-check]
    if: needs.route-review.outputs.review_mode != 'triage'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic PyGithub

      - name: Check rate limit
        id: rate_limit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/cost_optimizer.py --check-rate-limit \
            --pr-number "${{ github.event.pull_request.number || github.event.issue.number }}"

      - name: Run Claude review with caching
        if: steps.rate_limit.outputs.allowed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=${{ github.event.pull_request.number || github.event.issue.number }}
          REVIEW_MODE="${{ needs.route-review.outputs.review_mode }}"

          python .github/scripts/claude_reviewer.py \
            --pr-number "$PR_NUM" \
            --repo "${{ github.repository }}" \
            --mode "$REVIEW_MODE" \
            --use-cache

      - name: Log AI interaction (audit trail)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/security_compliance.py --log-interaction \
            --pr-number "${{ github.event.pull_request.number || github.event.issue.number }}" \
            --user "${{ github.actor }}"

      - name: Post review comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('claude_review.md')) {
              const review = fs.readFileSync('claude_review.md', 'utf8');
              const prNumber = ${{ github.event.pull_request.number || github.event.issue.number }};

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: `## ðŸ¤– Claude AI Review (Enhanced)\n\n**Mode**: ${{ needs.route-review.outputs.review_mode }}\n**Priority**: ${{ needs.route-review.outputs.priority }}\n\n${review}\n\n---\n*Multi-stage pipeline | Cached results | PII redacted*`
              });
            }

      - name: Upload review artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-review-${{ github.run_number }}
          path: |
            claude_review.md
            claude_review_details.json
            routing_decision.json

  # Stage 4: Deep Analysis (conditional)
  deep-analysis:
    name: Stage 3 - Deep Analysis
    runs-on: ubuntu-latest
    needs: [route-review, claude-review]
    if: needs.route-review.outputs.review_mode == 'deep'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install analysis tools
        run: |
          pip install pip-audit radon pip-licenses

      - name: Run multi-stage pipeline
        run: |
          python .github/scripts/multi_stage_pipeline.py

      - name: Upload pipeline results
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-report
          path: pipeline_report.json

  # Auto-fix (conditional)
  auto-fix:
    name: Auto-fix Issues
    runs-on: ubuntu-latest
    needs: [claude-review]
    if: contains(github.event.comment.body, '@claude fix:')

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install formatters
        run: |
          pip install ruff black isort autoflake

      - name: Apply auto-fixes
        run: |
          # Determine fix type from comment
          if echo "${{ github.event.comment.body }}" | grep -q "fix:formatting"; then
            ruff format .
            black .
          fi

          if echo "${{ github.event.comment.body }}" | grep -q "fix:imports"; then
            isort .
            autoflake --remove-all-unused-imports --in-place -r .
          fi

      - name: Commit fixes
        run: |
          git config --local user.email "claude-ai[bot]@users.noreply.github.com"
          git config --local user.name "Claude AI Bot"

          if [[ `git status --porcelain` ]]; then
            git add -A
            git commit -m "fix(auto): apply Claude AI auto-fixes

            Applied automatic fixes as requested.
            Triggered by: ${{ github.actor }}
            Review mode: ${{ needs.route-review.outputs.review_mode }}"
            git push
          fi

  # Learning & feedback
  collect-feedback:
    name: Collect Feedback
    runs-on: ubuntu-latest
    needs: [claude-review]
    if: github.event_name == 'pull_request_review'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Record feedback
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python .github/scripts/learning_feedback.py \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --record-review

  # Weekly reports
  weekly-metrics:
    name: Generate Weekly Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate reports
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Effectiveness report
          python .github/scripts/learning_feedback.py \
            --repo "${{ github.repository }}" \
            --report --days 7

          # Cost stats
          python .github/scripts/cost_optimizer.py --stats --days 7

          # Compliance report
          python .github/scripts/security_compliance.py --report

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: weekly-reports-${{ github.run_number }}
          path: |
            effectiveness_report.json
            compliance_report.json

      - name: Post report to discussions
        uses: actions/github-script@v7
        with:
          script: |
            // Post weekly summary to discussions or issue
            const fs = require('fs');
            const report = fs.readFileSync('effectiveness_report.json', 'utf8');
            console.log('Weekly report generated:', report);
